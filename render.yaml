services:
  - type: web
    name: dha-back-office
    env: node
    plan: standard

    # Build configuration
    buildCommand: npm install && mkdir -p /opt/render/project/attached_assets && cp -r attached_assets/* /opt/render/project/attached_assets/ 2>/dev/null || true
    startCommand: npm start

    # Environment variables - FIXED: using key/value only (no scope)
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3000"
      - key: DOCUMENT_SIGNING_KEY
        value: dha-signing-key-2025
      - key: DOCUMENT_ENCRYPTION_KEY
        value: dha-encryption-key-2025
      - key: JWT_SECRET
        value: dha-jwt-secret-2025
      - key: SESSION_SECRET
        value: dha-session-secret-2025
      - key: DHA_NPR_API_KEY
        value: npr-api-key-production
      - key: DHA_DMS_API_KEY
        value: dms-api-key-production
      - key: DHA_VISA_API_KEY
        value: visa-api-key-production
      - key: DHA_MCS_API_KEY
        value: mcs-api-key-production
      - key: DHA_ABIS_API_KEY
        value: abis-api-key-production
      - key: HANIS_API_KEY
        value: hanis-api-key-production

    # Health check
    healthCheckPath: /api/health

    # Auto-deploy
    autoDeploy: true

  # Background Worker for document verification monitoring
  - type: worker
    name: dha-verification-worker
    env: node
    region: frankfurt
    plan: starter
    buildCommand: npm install
    startCommand: node server/services/verification-worker.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: WORKER_TYPE
        value: verification

# Cron jobs for scheduled tasks
cronJobs:
  - name: health-check-monitor
    schedule: "*/5 * * * *"  # Every 5 minutes
    command: curl https://dha-verification-admin-portal-co-gov.onrender.com/api/health

  - name: permit-verification-sync
    schedule: "0 */6 * * *"  # Every 6 hours
    command: node server/services/permit-sync.js